<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimized AI Diagnosis - AfriDiag</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative;
        }

        /* Progress Bar */
        .progress-container {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dee2e6;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: #007bff;
            color: white;
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-title {
            font-size: 0.9em;
            color: #6c757d;
            text-align: center;
            font-weight: 500;
        }

        .step.active .step-title {
            color: #007bff;
            font-weight: 600;
        }

        .step.completed .step-title {
            color: #28a745;
        }

        .step-connector {
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: -1;
        }

        .step.completed .step-connector {
            background: #28a745;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .ai-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-badge::before {
            content: '🤖';
            font-size: 1.2em;
        }

        /* Content */
        .content {
            padding: 30px;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: #2a5298;
            box-shadow: 0 8px 25px rgba(42, 82, 152, 0.1);
        }

        .section-title {
            font-size: 1.4em;
            color: #2a5298;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #2a5298;
            margin-right: 12px;
            border-radius: 2px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .required::after {
            content: ' *';
            color: #dc3545;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 0.875em;
            margin-top: 5px;
            display: none;
        }

        .success-message {
            color: #28a745;
            font-size: 0.875em;
            margin-top: 5px;
            display: none;
        }

        /* Symptoms Grid */
        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .symptom-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .symptom-item:hover {
            border-color: #2a5298;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 82, 152, 0.1);
        }

        .symptom-item.selected {
            border-color: #4caf50;
            background: #e8f5e8;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        .symptom-item input[type="checkbox"] {
            margin-right: 12px;
            width: auto;
            transform: scale(1.2);
        }

        .symptom-label {
            font-weight: 500;
            flex: 1;
        }

        /* AI Enhancement Toggle */
        .ai-enhancement-section {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border: 2px solid #4caf50;
            position: relative;
        }

        .ai-enhancement-section::before {
            content: '🤖 AI ENHANCED';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #4caf50;
            color: white;
            padding: 6px 15px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .toggle-switch.active {
            background: #4caf50;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-switch.active::after {
            transform: translateX(30px);
        }

        /* Navigation Buttons */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            width: 100%;
            padding: 18px;
            font-size: 1.2em;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Enhanced Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Status Messages */
        .status-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .status-message {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 300px;
            transform: translateX(100%);
            animation: slideIn 0.3s ease forwards;
        }

        @keyframes slideIn {
            to { transform: translateX(0); }
        }

        .status-success {
            border-left: 4px solid #28a745;
        }

        .status-error {
            border-left: 4px solid #dc3545;
        }

        .status-warning {
            border-left: 4px solid #ffc107;
        }

        .status-info {
            border-left: 4px solid #17a2b8;
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #28a745;
        }

        .diagnosis-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .confidence-bar {
            width: 100%;
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            border-radius: 6px;
            transition: width 1s ease;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .container {
                margin: 5px;
                border-radius: 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .ai-badge {
                position: static;
                margin-top: 15px;
                align-self: center;
            }

            .content {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .symptoms-grid {
                grid-template-columns: 1fr;
            }

            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }

            .step-connector {
                display: none;
            }

            .navigation {
                flex-direction: column;
                gap: 15px;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Focus indicators */
        .symptom-item:focus,
        .toggle-switch:focus,
        .btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Patient Info</div>
                    <div class="step-connector"></div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Symptoms</div>
                    <div class="step-connector"></div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Medical Data</div>
                    <div class="step-connector"></div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">AI Analysis</div>
                    <div class="step-connector"></div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">Results</div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="ai-badge">AI Enhanced</div>
            <h1>Optimized AI Diagnosis</h1>
            <p>Advanced medical diagnosis with enhanced user experience</p>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Step 1: Patient Information -->
            <div class="step-content active" data-step="1">
                <div class="section">
                    <div class="section-title">👤 Patient Information</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientName" class="required">Patient Name</label>
                            <input type="text" id="patientName" placeholder="Enter patient's full name" required>
                            <div class="error-message" id="patientNameError">Please enter patient name</div>
                        </div>
                        <div class="form-group">
                            <label for="patientAge" class="required">Age</label>
                            <input type="number" id="patientAge" min="0" max="120" placeholder="Enter age" required>
                            <div class="error-message" id="patientAgeError">Please enter a valid age</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="patientGender" class="required">Gender</label>
                            <select id="patientGender" required>
                                <option value="">Select gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="error-message" id="patientGenderError">Please select gender</div>
                        </div>
                        <div class="form-group">
                            <label for="patientPhone">Phone Number</label>
                            <input type="tel" id="patientPhone" placeholder="Enter phone number">
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <div></div>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Next: Symptoms →
                    </button>
                </div>
            </div>

            <!-- Step 2: Symptoms -->
            <div class="step-content" data-step="2">
                <div class="section">
                    <div class="section-title">🩺 Symptoms Selection</div>
                    
                    <p style="margin-bottom: 20px; color: #666;">Select all symptoms that the patient is experiencing:</p>
                    
                    <div class="symptoms-grid" id="symptomsGrid">
                        <!-- Symptoms will be populated by JavaScript -->
                    </div>

                    <div class="form-group" style="margin-top: 25px;">
                        <label for="additionalSymptoms">Additional Symptoms</label>
                        <textarea id="additionalSymptoms" placeholder="Describe any additional symptoms not listed above..."></textarea>
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        ← Previous
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Next: Medical Data →
                    </button>
                </div>
            </div>

            <!-- Step 3: Medical Data -->
            <div class="step-content" data-step="3">
                <div class="section">
                    <div class="section-title">📊 Vital Signs</div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="temperature">Temperature (°C)</label>
                            <input type="number" id="temperature" step="0.1" placeholder="e.g., 37.5">
                        </div>
                        <div class="form-group">
                            <label for="heartRate">Heart Rate (bpm)</label>
                            <input type="number" id="heartRate" placeholder="e.g., 80">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="respiratoryRate">Respiratory Rate (breaths/min)</label>
                            <input type="number" id="respiratoryRate" placeholder="e.g., 16">
                        </div>
                        <div class="form-group">
                            <label for="oxygenSaturation">Oxygen Saturation (%)</label>
                            <input type="number" id="oxygenSaturation" min="0" max="100" placeholder="e.g., 98">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="systolicBP">Systolic BP (mmHg)</label>
                            <input type="number" id="systolicBP" placeholder="e.g., 120">
                        </div>
                        <div class="form-group">
                            <label for="diastolicBP">Diastolic BP (mmHg)</label>
                            <input type="number" id="diastolicBP" placeholder="e.g., 80">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">📋 Medical History</div>
                    
                    <div class="form-group">
                        <label for="medicalHistory">Medical History</label>
                        <textarea id="medicalHistory" placeholder="Previous illnesses, chronic conditions, medications, allergies, family history..."></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="urgencyLevel">Urgency Level</label>
                            <select id="urgencyLevel">
                                <option value="routine">Routine</option>
                                <option value="urgent">Urgent</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="clinicalNotes">Clinical Notes</label>
                            <textarea id="clinicalNotes" placeholder="Additional observations or notes..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        ← Previous
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">
                        Next: AI Analysis →
                    </button>
                </div>
            </div>

            <!-- Step 4: AI Analysis Options -->
            <div class="step-content" data-step="4">
                <div class="section ai-enhancement-section">
                    <div class="section-title">🤖 AI Analysis Configuration</div>
                    
                    <div class="toggle-container">
                        <span style="font-weight: 600;">Enhanced AI Analysis:</span>
                        <div class="toggle-switch active" id="toggleSwitch" onclick="toggleAI()" tabindex="0" role="switch" aria-checked="true">
                            <span class="sr-only">Toggle Enhanced AI Analysis</span>
                        </div>
                        <input type="checkbox" id="useEnhancedAI" checked style="display: none;">
                        <span id="toggleLabel" style="color: #4caf50; font-weight: 600;">Enabled</span>
                    </div>

                    <div class="ai-features" id="aiFeatures">
                        <div class="ai-feature">
                            <h4>🧠 Advanced Pattern Recognition</h4>
                            <p>Deep learning analysis of symptom patterns and correlations</p>
                        </div>
                        <div class="ai-feature">
                            <h4>📊 Differential Diagnosis</h4>
                            <p>Multiple diagnosis possibilities with confidence scores</p>
                        </div>
                        <div class="ai-feature">
                            <h4>🌍 Cultural Context</h4>
                            <p>Region-specific disease prevalence and cultural considerations</p>
                        </div>
                        <div class="ai-feature">
                            <h4>💊 Treatment Recommendations</h4>
                            <p>Evidence-based treatment suggestions and guidelines</p>
                        </div>
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        ← Previous
                    </button>
                    <button type="button" class="btn btn-success" onclick="submitDiagnosis()">
                        🤖 Generate AI Diagnosis
                    </button>
                </div>
            </div>

            <!-- Step 5: Results -->
            <div class="step-content" data-step="5">
                <div class="results-container" id="resultsContainer">
                    <div class="section-title">📋 Diagnosis Results</div>
                    <div id="resultsContent">
                        <!-- Results will be populated here -->
                    </div>
                </div>

                <div class="navigation">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        🔄 New Diagnosis
                    </button>
                    <button type="button" class="btn btn-primary" onclick="printResults()">
                        🖨️ Print Results
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingTitle">🤖 AI Analysis in Progress</h3>
            <p id="loadingMessage">Analyzing symptoms and medical data...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">0% Complete</p>
        </div>
    </div>

    <!-- Status Messages Container -->
    <div class="status-container" id="statusContainer"></div>

    <script>
        // Global variables
        let currentStep = 1;
        let currentPatient = null;
        let uploadedImages = [];
        let selectedSymptoms = [];

        // Common symptoms list
        const commonSymptoms = [
            'Fever', 'Headache', 'Cough', 'Fatigue', 'Nausea', 'Vomiting',
            'Diarrhea', 'Abdominal pain', 'Chest pain', 'Shortness of breath',
            'Dizziness', 'Joint pain', 'Muscle aches', 'Sore throat',
            'Runny nose', 'Loss of appetite', 'Weight loss', 'Night sweats',
            'Skin rash', 'Swollen lymph nodes', 'Difficulty swallowing',
            'Blurred vision', 'Confusion', 'Seizures', 'Back pain'
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSymptoms();
            autoLogin();
            
            // Add keyboard navigation
            document.addEventListener('keydown', handleKeyboardNavigation);
        });

        function initializeSymptoms() {
            const symptomsGrid = document.getElementById('symptomsGrid');
            symptomsGrid.innerHTML = '';

            commonSymptoms.forEach((symptom, index) => {
                const symptomItem = document.createElement('div');
                symptomItem.className = 'symptom-item';
                symptomItem.setAttribute('tabindex', '0');
                symptomItem.setAttribute('role', 'checkbox');
                symptomItem.setAttribute('aria-checked', 'false');
                
                symptomItem.innerHTML = `
                    <input type="checkbox" id="symptom_${index}" value="${symptom}" onchange="toggleSymptom(this)">
                    <label for="symptom_${index}" class="symptom-label">${symptom}</label>
                `;
                
                symptomItem.onclick = function() {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    toggleSymptom(checkbox);
                };

                symptomsGrid.appendChild(symptomItem);
            });
        }

        function toggleSymptom(checkbox) {
            const symptomItem = checkbox.closest('.symptom-item');
            
            if (checkbox.checked) {
                symptomItem.classList.add('selected');
                symptomItem.setAttribute('aria-checked', 'true');
                selectedSymptoms.push(checkbox.value);
            } else {
                symptomItem.classList.remove('selected');
                symptomItem.setAttribute('aria-checked', 'false');
                selectedSymptoms = selectedSymptoms.filter(s => s !== checkbox.value);
            }
        }

        function toggleAI() {
            const checkbox = document.getElementById('useEnhancedAI');
            const toggleSwitch = document.getElementById('toggleSwitch');
            const toggleLabel = document.getElementById('toggleLabel');
            const aiFeatures = document.getElementById('aiFeatures');
            
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                toggleSwitch.classList.add('active');
                toggleSwitch.setAttribute('aria-checked', 'true');
                toggleLabel.textContent = 'Enabled';
                toggleLabel.style.color = '#4caf50';
                aiFeatures.style.display = 'grid';
            } else {
                toggleSwitch.classList.remove('active');
                toggleSwitch.setAttribute('aria-checked', 'false');
                toggleLabel.textContent = 'Disabled';
                toggleLabel.style.color = '#6c757d';
                aiFeatures.style.display = 'none';
            }
        }

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep < 5) {
                    updateStep(currentStep + 1);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                updateStep(currentStep - 1);
            }
        }

        function updateStep(step) {
            // Hide current step content
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
            
            // Update progress
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.remove('active');
            if (step > currentStep) {
                document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('completed');
            }
            
            // Show new step content
            currentStep = step;
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.step[data-step="${currentStep}"]`).classList.add('active');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateCurrentStep() {
            let isValid = true;
            
            if (currentStep === 1) {
                // Validate patient information
                const name = document.getElementById('patientName').value.trim();
                const age = document.getElementById('patientAge').value;
                const gender = document.getElementById('patientGender').value;
                
                isValid = validateField('patientName', name, 'Please enter patient name') && isValid;
                isValid = validateField('patientAge', age && age > 0 && age <= 120, 'Please enter a valid age (1-120)') && isValid;
                isValid = validateField('patientGender', gender, 'Please select gender') && isValid;
                
                if (isValid) {
                    // Create or update patient object
                    currentPatient = {
                        name: name,
                        age: parseInt(age),
                        gender: gender,
                        phone: document.getElementById('patientPhone').value.trim()
                    };
                }
            } else if (currentStep === 2) {
                // Validate symptoms
                const selectedSymptomsCount = document.querySelectorAll('#symptomsGrid input[type="checkbox"]:checked').length;
                const additionalSymptoms = document.getElementById('additionalSymptoms').value.trim();
                
                if (selectedSymptomsCount === 0 && !additionalSymptoms) {
                    showStatus('Please select at least one symptom or describe additional symptoms', 'error');
                    isValid = false;
                }
            }
            
            return isValid;
        }

        function validateField(fieldId, condition, errorMessage) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');
            
            if (!condition) {
                field.classList.add('input-error');
                errorElement.style.display = 'block';
                errorElement.textContent = errorMessage;
                return false;
            } else {
                field.classList.remove('input-error');
                errorElement.style.display = 'none';
                return true;
            }
        }

        async function submitDiagnosis() {
            if (!validateCurrentStep()) {
                return;
            }

            // Collect all form data
            const selectedSymptomsFromGrid = Array.from(document.querySelectorAll('#symptomsGrid input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            const additionalSymptoms = document.getElementById('additionalSymptoms').value.trim();
            const allSymptoms = [...selectedSymptomsFromGrid];
            if (additionalSymptoms) {
                allSymptoms.push(additionalSymptoms);
            }

            const useEnhancedAI = document.getElementById('useEnhancedAI').checked;
            
            const diagnosisData = {
                patient_id: currentPatient?.id || null,
                disease_code: useEnhancedAI ? 'unknown' : 'other',
                symptoms: JSON.stringify(allSymptoms),
                notes: document.getElementById('clinicalNotes').value || '',
                patient_data: {
                    name: currentPatient.name,
                    age: currentPatient.age,
                    gender: currentPatient.gender,
                    phone: currentPatient.phone,
                    temperature: parseFloat(document.getElementById('temperature').value) || null,
                    heart_rate: parseInt(document.getElementById('heartRate').value) || null,
                    respiratory_rate: parseInt(document.getElementById('respiratoryRate').value) || null,
                    systolic_bp: parseInt(document.getElementById('systolicBP').value) || null,
                    diastolic_bp: parseInt(document.getElementById('diastolicBP').value) || null,
                    oxygen_saturation: parseFloat(document.getElementById('oxygenSaturation').value) || null
                },
                medical_history: document.getElementById('medicalHistory').value || '',
                urgency_level: document.getElementById('urgencyLevel').value || 'routine'
            };

            console.log('Submitting diagnosis:', diagnosisData);

            // Show enhanced loading
            showEnhancedLoading(useEnhancedAI);
            
            try {
                const endpoint = useEnhancedAI ? 
                    'http://127.0.0.1:8001/api/v1/diagnoses/enhanced' : 
                    'http://127.0.0.1:8001/api/v1/diagnoses/predict';
                
                const token = localStorage.getItem('token');
                const medicalHistory = encodeURIComponent(diagnosisData.medical_history);
                const finalEndpoint = useEnhancedAI ? 
                    `${endpoint}?medical_history=${medicalHistory}` : 
                    endpoint;

                const response = await fetch(finalEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(diagnosisData)
                });

                const result = await response.json();
                
                if (response.ok || response.status === 201) {
                    showStatus('✅ AI diagnosis completed successfully!', 'success');
                    displayResults(result, useEnhancedAI);
                    updateStep(5);
                } else {
                    showStatus(`❌ Error: ${result.detail || 'Diagnosis failed'}`, 'error');
                }
            } catch (error) {
                console.error('Diagnosis error:', error);
                showStatus('❌ Connection error. Please check if the backend is running.', 'error');
            } finally {
                hideLoading();
            }
        }

        function showEnhancedLoading(isEnhanced) {
            const overlay = document.getElementById('loadingOverlay');
            const title = document.getElementById('loadingTitle');
            const message = document.getElementById('loadingMessage');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            overlay.style.display = 'flex';
            
            if (isEnhanced) {
                title.textContent = '🤖 Enhanced AI Analysis in Progress';
                message.textContent = 'Performing deep learning analysis of symptoms and medical data...';
            } else {
                title.textContent = '📊 Standard Analysis in Progress';
                message.textContent = 'Processing symptoms and generating diagnosis...';
            }
            
            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 95) progress = 95;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% Complete';
                
                if (progress >= 95) {
                    clearInterval(progressInterval);
                }
            }, 500);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function displayResults(result, isEnhanced) {
            const resultsContainer = document.getElementById('resultsContainer');
            const resultsContent = document.getElementById('resultsContent');
            
            let content = '';
            
            if (isEnhanced && result.ai_diagnosis) {
                const confidence = result.ai_confidence || 0;
                let confidencePercent;
                // Check if confidence is already a percentage (> 1) or decimal (0-1)
                if (confidence > 1) {
                    confidencePercent = Math.round(confidence);
                } else {
                    confidencePercent = Math.round(confidence * 100);
                }
                // Ensure confidence is within reasonable bounds (10-95%)
                confidencePercent = Math.max(10, Math.min(95, confidencePercent));
                
                content = `
                    <div class="diagnosis-card">
                        <h4>🤖 AI-Enhanced Diagnosis</h4>
                        <p><strong>Primary Diagnosis:</strong> ${result.ai_diagnosis}</p>
                        <p><strong>Confidence Level:</strong> ${confidencePercent}%</p>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                        </div>
                        <p><strong>Clinical Reasoning:</strong> ${result.ai_reasoning || 'Advanced AI analysis completed'}</p>
                    </div>
                `;

                if (result.enhanced_analysis) {
                    content += `
                        <div class="diagnosis-card" style="border-left-color: #4caf50;">
                            <h4>🧠 Detailed AI Analysis</h4>
                            <p><strong>Diagnosis:</strong> ${result.enhanced_analysis.diagnosis || 'N/A'}</p>
                            <p><strong>Differential Diagnoses:</strong> ${result.enhanced_analysis.differential_diagnoses || 'N/A'}</p>
                            <p><strong>Treatment Recommendations:</strong> ${result.enhanced_analysis.treatment_recommendations || 'N/A'}</p>
                            <p><strong>Cultural Considerations:</strong> ${result.enhanced_analysis.cultural_considerations || 'N/A'}</p>
                        </div>
                    `;
                }
            } else if (result.prediction) {
                content = `
                    <div class="diagnosis-card">
                        <h4>📊 Standard AI Prediction</h4>
                        <p><strong>Disease:</strong> ${result.prediction.disease || 'N/A'}</p>
                        <p><strong>Confidence:</strong> ${(() => {
                            if (!result.prediction.confidence) return 'N/A';
                            let confValue = result.prediction.confidence;
                            if (confValue > 1) {
                                return Math.round(confValue) + '%';
                            } else {
                                return Math.round(confValue * 100) + '%';
                            }
                        })()}</p>
                        <p><strong>Risk Level:</strong> ${result.prediction.risk_level || 'N/A'}</p>
                    </div>
                `;
            }
            
            if (result.diagnosis_id) {
                content += `
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <p><strong>Diagnosis ID:</strong> ${result.diagnosis_id}</p>
                        <p><strong>Patient:</strong> ${currentPatient.name}</p>
                        <p><strong>Timestamp:</strong> ${new Date().toLocaleString()}</p>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = content;
            resultsContainer.style.display = 'block';
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
            statusDiv.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    container.removeChild(statusDiv);
                }, 300);
            }, 5000);
        }

        function resetForm() {
            currentStep = 1;
            currentPatient = null;
            selectedSymptoms = [];
            
            // Reset all form fields
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else {
                    field.value = '';
                }
                field.classList.remove('input-error');
            });
            
            // Reset symptoms
            document.querySelectorAll('.symptom-item').forEach(item => {
                item.classList.remove('selected');
                item.setAttribute('aria-checked', 'false');
            });
            
            // Reset steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelector('.step[data-step="1"]').classList.add('active');
            
            // Reset step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector('.step-content[data-step="1"]').classList.add('active');
            
            // Hide results
            document.getElementById('resultsContainer').style.display = 'none';
            
            // Reset AI toggle
            document.getElementById('useEnhancedAI').checked = true;
            document.getElementById('toggleSwitch').classList.add('active');
            document.getElementById('toggleLabel').textContent = 'Enabled';
            document.getElementById('toggleLabel').style.color = '#4caf50';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function printResults() {
            window.print();
        }

        function handleKeyboardNavigation(event) {
            if (event.key === 'Enter' || event.key === ' ') {
                const activeElement = document.activeElement;
                
                if (activeElement.classList.contains('symptom-item')) {
                    event.preventDefault();
                    activeElement.click();
                } else if (activeElement.classList.contains('toggle-switch')) {
                    event.preventDefault();
                    toggleAI();
                }
            }
        }

        // Auto-login function (simplified)
        async function autoLogin() {
            try {
                const response = await fetch('http://127.0.0.1:8001/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'demo_user',
                        password: 'demo_password'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('token', data.access_token);
                    console.log('Auto-login successful');
                } else {
                    console.log('Auto-login failed, but continuing...');
                }
            } catch (error) {
                console.log('Auto-login error:', error);
            }
        }
    </script>
</body>
</html>