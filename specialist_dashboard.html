<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specialist Dashboard - AfriDiag</title>
    <link rel="stylesheet" href="css/navigation.css">
    <script src="/frontend/specialist_database.js"></script>
    <script src="/frontend/availability_manager.js"></script>
    <script src="/frontend/notification_system.js"></script>
    
    <!-- Authentication Check -->
    <script>
        // Check authentication on page load
        function checkAuthentication() {
            const token = localStorage.getItem('access_token') || localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            
            if (!token) {
                console.log('No authentication token found, redirecting to login');
                window.location.href = 'login.html';
                return false;
            }
            
            // Check if user is a specialist
            if (userRole && userRole !== 'specialist') {
                console.log('User is not a specialist, redirecting to main dashboard');
                window.location.href = 'index.html';
                return false;
            }
            
            return true;
        }
        
        // Run authentication check immediately
        if (!checkAuthentication()) {
            // Stop page loading if not authenticated
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;"><h2>Redirecting to login...</h2><p>Please wait while we redirect you to the login page.</p></div>';
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .specialist-profile {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .profile-info h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .profile-info .specialization {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .profile-info .location {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .status-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }

        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 15px;
        }

        .status-options {
            display: flex;
            gap: 10px;
        }

        .status-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            background: transparent;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .status-btn.active {
            background: white;
            color: #4CAF50;
            border-color: white;
        }

        .status-btn.available.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .status-btn.partially.active {
            background: #FF9800;
            color: white;
            border-color: #FF9800;
        }

        .status-btn.unavailable.active {
            background: #f44336;
            color: white;
            border-color: #f44336;
        }

        .dashboard-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .dashboard-content {
            padding: 30px;
        }

        .content-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .tab-button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .tab-button:hover {
            background: rgba(76, 175, 80, 0.05);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 15px;
            background: #f44336;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .consultation-requests {
            display: grid;
            gap: 20px;
        }

        .request-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #4CAF50;
            transition: all 0.3s ease;
        }

        .request-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .request-card.urgent {
            border-left-color: #f44336;
            background: linear-gradient(135deg, #fff 0%, #ffebee 100%);
        }

        .request-card.medium {
            border-left-color: #FF9800;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .request-info h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1.3rem;
        }

        .request-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #666;
        }

        .urgency-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .urgency-high {
            background: #ffebee;
            color: #c62828;
            animation: pulse-red 2s infinite;
        }

        .urgency-medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .urgency-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        .patient-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .summary-label {
            font-weight: 600;
            color: #666;
        }

        .summary-value {
            color: #333;
        }

        .symptoms-section {
            margin-top: 15px;
        }

        .symptoms-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .symptoms-list {
            color: #666;
            line-height: 1.6;
        }

        .original-diagnosis-section {
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 12px;
            border: 2px solid #2196F3;
        }

        .original-diagnosis-section h4 {
            color: #1976D2;
            margin-bottom: 12px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .diagnosis-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .diagnosis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .diagnosis-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1976D2;
        }

        .confidence-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }

        .confidence-high {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .confidence-medium {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .confidence-low {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .differential-diagnoses {
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #FF9800;
        }

        .differential-diagnoses ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .differential-diagnoses li {
            margin: 5px 0;
            color: #555;
        }

        .diagnosis-reasoning {
            margin: 12px 0;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .diagnosis-reasoning p {
            margin: 8px 0 0 0;
            color: #555;
            line-height: 1.5;
        }

        .response-btn {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }

        .response-btn:hover {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
            transform: translateY(-2px);
        }

        .request-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .accept-btn {
            background: #4CAF50;
            color: white;
        }

        .accept-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .chat-btn {
            background: #2196F3;
            color: white;
        }

        .chat-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .decline-btn {
            background: #f44336;
            color: white;
        }

        .decline-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .view-btn {
            background: #FF9800;
            color: white;
        }

        .view-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .active-consultations {
            display: grid;
            gap: 20px;
        }

        .consultation-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #2196F3;
        }

        .consultation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .consultation-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            background: #e3f2fd;
            color: #1976d2;
        }

        .last-message {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-style: italic;
            color: #666;
        }

        .schedule-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-header {
            text-align: center;
            font-weight: 600;
            color: #666;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .time-slot {
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-slot.available {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .time-slot.busy {
            background: #ffebee;
            color: #c62828;
        }

        .time-slot.partially {
            background: #fff3e0;
            color: #ef6c00;
        }

        .time-slot:hover {
            transform: scale(1.05);
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .analytics-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .analytics-label {
            color: #666;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .analytics-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .analytics-change.positive {
            color: #4CAF50;
        }

        .analytics-change.negative {
            color: #f44336;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .quick-action-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .quick-action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .quick-action-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .quick-action-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .quick-action-desc {
            font-size: 0.9rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .specialist-profile {
                flex-direction: column;
                text-align: center;
            }
            
            .dashboard-stats {
                justify-content: center;
            }
            
            .content-tabs {
                flex-direction: column;
            }
            
            .tab-button {
                text-align: center;
            }
            
            .request-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .request-actions {
                flex-direction: column;
            }
            
            .dashboard-content {
                padding: 20px;
            }
        }

        /* Second Opinion Modal Styles */
        .second-opinion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.3rem;
        }

        .close-modal {
            font-size: 24px;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .close-modal:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .patient-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .patient-summary h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .patient-summary p {
            margin: 5px 0;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="specialist-profile">
                <div class="profile-avatar">üë©‚Äç‚öïÔ∏è</div>
                <div class="profile-info">
                    <h1>Dr. Sarah Johnson</h1>
                    <div class="specialization">Cardiology Specialist</div>
                    <div class="location">üìç Nairobi Heart Institute, Kenya</div>
                </div>
            </div>
            
            <div class="status-controls">
                <div class="availability-toggle">
                    <span>Availability Status:</span>
                    <div class="status-options">
                        <button class="status-btn available active" onclick="setStatus('available')">üü¢ Available</button>
                        <button class="status-btn partially" onclick="setStatus('partially')">üü° Partially</button>
                        <button class="status-btn unavailable" onclick="setStatus('unavailable')">üî¥ Unavailable</button>
                    </div>
                </div>
                
                <div class="dashboard-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="pendingRequests">5</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="activeConsultations">3</div>
                        <div class="stat-label">Active</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="todayConsultations">12</div>
                        <div class="stat-label">Today</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
            <!-- Content Tabs -->
            <div class="content-tabs">
                <button class="tab-button active" onclick="switchTab('requests')">
                    Consultation Requests
                    <span class="notification-badge" id="requestsBadge">5</span>
                </button>
                <button class="tab-button" onclick="switchTab('active')">
                    Active Consultations
                    <span class="notification-badge" id="activeBadge">3</span>
                </button>
                <button class="tab-button" onclick="switchTab('schedule')">My Schedule</button>
                <button class="tab-button" onclick="switchTab('analytics')">Analytics</button>
            </div>

            <!-- Consultation Requests Tab -->
            <div class="tab-content active" id="requests-tab">
                <div class="consultation-requests" id="consultationRequests">
                    <!-- Requests will be loaded here -->
                </div>
            </div>

            <!-- Active Consultations Tab -->
            <div class="tab-content" id="active-tab">
                <div class="active-consultations" id="activeConsultations">
                    <!-- Active consultations will be loaded here -->
                </div>
            </div>

            <!-- Schedule Tab -->
            <div class="tab-content" id="schedule-tab">
                <div class="schedule-section">
                    <div class="schedule-header">
                        <h3>üìÖ Weekly Schedule</h3>
                        <div>
                            <button class="action-btn view-btn" onclick="editSchedule()">Edit Schedule</button>
                        </div>
                    </div>
                    
                    <div class="schedule-grid">
                        <div class="day-header">Mon</div>
                        <div class="day-header">Tue</div>
                        <div class="day-header">Wed</div>
                        <div class="day-header">Thu</div>
                        <div class="day-header">Fri</div>
                        <div class="day-header">Sat</div>
                        <div class="day-header">Sun</div>
                        
                        <!-- Time slots will be generated by JavaScript -->
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="blockTime()">
                        <div class="quick-action-icon">üö´</div>
                        <div class="quick-action-title">Block Time</div>
                        <div class="quick-action-desc">Mark unavailable periods</div>
                    </div>
                    <div class="quick-action-card" onclick="setRecurring()">
                        <div class="quick-action-icon">üîÑ</div>
                        <div class="quick-action-title">Recurring Schedule</div>
                        <div class="quick-action-desc">Set weekly patterns</div>
                    </div>
                    <div class="quick-action-card" onclick="emergencyMode()">
                        <div class="quick-action-icon">üö®</div>
                        <div class="quick-action-title">Emergency Mode</div>
                        <div class="quick-action-desc">Available for emergencies only</div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="analytics-tab">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-number">47</div>
                        <div class="analytics-label">Total Consultations</div>
                        <div class="analytics-change positive">+12% this week</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number">4.9</div>
                        <div class="analytics-label">Average Rating</div>
                        <div class="analytics-change positive">+0.2 this month</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number">8</div>
                        <div class="analytics-label">Avg Response Time (min)</div>
                        <div class="analytics-change positive">-2 min improved</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-number">92%</div>
                        <div class="analytics-label">Success Rate</div>
                        <div class="analytics-change positive">+3% this month</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="viewDetailedAnalytics()">
                        <div class="quick-action-icon">üìä</div>
                        <div class="quick-action-title">Detailed Reports</div>
                        <div class="quick-action-desc">View comprehensive analytics</div>
                    </div>
                    <div class="quick-action-card" onclick="exportData()">
                        <div class="quick-action-icon">üì•</div>
                        <div class="quick-action-title">Export Data</div>
                        <div class="quick-action-desc">Download consultation data</div>
                    </div>
                    <div class="quick-action-card" onclick="feedbackReview()">
                        <div class="quick-action-icon">üí¨</div>
                        <div class="quick-action-title">Patient Feedback</div>
                        <div class="quick-action-desc">Review ratings and comments</div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
        // Navigation removed - users can access pages directly from homepage dashboard

        // Sample consultation requests data
        const consultationRequests = [
            {
                id: 1,
                patientName: "John Doe",
                age: 45,
                gender: "Male",
                location: "Rural Clinic, Mombasa",
                urgency: "high",
                chiefComplaint: "Severe chest pain",
                symptoms: "Chest pain radiating to left arm, shortness of breath, sweating",
                vitals: {
                    bp: "140/90",
                    hr: "95",
                    temp: "37.2¬∞C",
                    spo2: "98%"
                },
                medicalHistory: "Type 2 Diabetes, Hypertension",
                requestTime: "10 minutes ago",
                requestedBy: "Nurse Mary Wanjiku",
                attachments: ["ECG Results", "Chest X-Ray"],
                originalDiagnosis: {
                    primary: "Acute Myocardial Infarction (STEMI)",
                    confidence: 85,
                    differential: [
                        { condition: "Unstable Angina", probability: 12 },
                        { condition: "Aortic Dissection", probability: 3 }
                    ],
                    reasoning: "Based on chest pain characteristics, ECG changes showing ST elevation, and risk factors including diabetes and hypertension. Immediate cardiology consultation recommended."
                }
            },
            {
                id: 2,
                patientName: "Grace Muthoni",
                age: 28,
                gender: "Female",
                location: "Health Center, Nakuru",
                urgency: "medium",
                chiefComplaint: "Persistent headache",
                symptoms: "Severe headache for 3 days, nausea, sensitivity to light",
                vitals: {
                    bp: "120/80",
                    hr: "88",
                    temp: "38.1¬∞C",
                    spo2: "99%"
                },
                medicalHistory: "No significant history",
                requestTime: "25 minutes ago",
                requestedBy: "Dr. James Kiprotich",
                attachments: ["Blood Test Results"],
                originalDiagnosis: {
                    primary: "Tension-Type Headache",
                    confidence: 65,
                    differential: [
                        { condition: "Migraine without Aura", probability: 25 },
                        { condition: "Sinusitis", probability: 8 },
                        { condition: "Meningitis", probability: 2 }
                    ],
                    reasoning: "Persistent headache with photophobia and nausea suggests possible migraine. However, fever present warrants investigation for infectious causes. Recommend neurological evaluation."
                }
            },
            {
                id: 3,
                patientName: "Peter Ochieng",
                age: 62,
                gender: "Male",
                location: "Dispensary, Kisumu",
                urgency: "low",
                chiefComplaint: "Routine follow-up",
                symptoms: "Diabetes management consultation, stable condition",
                vitals: {
                    bp: "130/85",
                    hr: "72",
                    temp: "36.8¬∞C",
                    spo2: "97%"
                },
                medicalHistory: "Type 2 Diabetes (10 years), Mild Hypertension",
                requestTime: "1 hour ago",
                requestedBy: "Clinical Officer Susan Akinyi",
                attachments: ["HbA1c Results", "Medication List"],
                originalDiagnosis: {
                    primary: "Type 2 Diabetes Mellitus - Well Controlled",
                    confidence: 95,
                    differential: [
                        { condition: "Diabetic Nephropathy (early)", probability: 4 },
                        { condition: "Diabetic Retinopathy (screening needed)", probability: 1 }
                    ],
                    reasoning: "Routine diabetes follow-up with stable HbA1c levels. Current medication regimen appears effective. Recommend continued monitoring and annual screening for complications."
                }
            }
        ];

        // Sample active consultations
        const activeConsultations = [
            {
                id: 1,
                patientName: "Alice Njeri",
                startTime: "2 hours ago",
                status: "In Progress",
                lastMessage: "Thank you for the medication recommendations. The patient is responding well.",
                requestedBy: "Dr. Michael Kamau",
                urgency: "medium"
            },
            {
                id: 2,
                patientName: "David Mwangi",
                startTime: "45 minutes ago",
                status: "Waiting for Response",
                lastMessage: "I've uploaded the latest lab results. Please review when you have a moment.",
                requestedBy: "Nurse Jane Wambui",
                urgency: "low"
            },
            {
                id: 3,
                patientName: "Sarah Achieng",
                startTime: "30 minutes ago",
                status: "Emergency",
                lastMessage: "Patient condition is deteriorating. Need immediate guidance on next steps.",
                requestedBy: "Dr. Robert Otieno",
                urgency: "high"
            }
        ];

        let currentStatus = 'available';

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            loadConsultationRequests();
            loadActiveConsultations();
            generateSchedule();
            
            // Load initial data from API
            await loadConsultationRequestsFromAPI();
            await loadActiveConsultationsFromAPI();
            await loadConsultationStats();
            
            updateNotificationBadges();
        });

        function switchTab(tabName) {
            // Remove active class from all tabs and buttons
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected tab and button
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load content based on tab
            switch(tabName) {
                case 'requests':
                    loadConsultationRequests();
                    break;
                case 'active':
                    loadActiveConsultations();
                    break;
                case 'schedule':
                    generateSchedule();
                    break;
                case 'analytics':
                    // Analytics are static for demo
                    break;
            }
        }

        function setStatus(status) {
            currentStatus = status;
            
            // Update button states
            document.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.status-btn.${status}`).classList.add('active');
            
            // Show confirmation
            const statusText = status === 'available' ? 'Available' : 
                             status === 'partially' ? 'Partially Available' : 'Unavailable';
            alert(`Status updated to: ${statusText}\n\nHealthcare workers will see your updated availability status.`);
        }

        function loadConsultationRequests() {
            const container = document.getElementById('consultationRequests');
            
            container.innerHTML = consultationRequests.map(request => `
                <div class="request-card ${request.urgency}">
                    <div class="request-header">
                        <div class="request-info">
                            <h3>üë§ ${request.patientName}</h3>
                            <div class="request-meta">
                                <div class="meta-item">
                                    <span>üë®‚Äç‚öïÔ∏è</span>
                                    <span>Requested by: ${request.requestedBy}</span>
                                </div>
                                <div class="meta-item">
                                    <span>üìç</span>
                                    <span>${request.location}</span>
                                </div>
                                <div class="meta-item">
                                    <span>‚è∞</span>
                                    <span>${request.requestTime}</span>
                                </div>
                            </div>
                        </div>
                        <div class="urgency-badge urgency-${request.urgency}">
                            ${request.urgency} Priority
                        </div>
                    </div>
                    
                    <div class="patient-summary">
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">Age:</span>
                                <span class="summary-value">${request.age} years</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Gender:</span>
                                <span class="summary-value">${request.gender}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">BP:</span>
                                <span class="summary-value">${request.vitals?.bp || 'N/A'} mmHg</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">HR:</span>
                                <span class="summary-value">${request.vitals?.hr || 'N/A'} bpm</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Temp:</span>
                                <span class="summary-value">${request.vitals?.temp || 'N/A'}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">SpO2:</span>
                                <span class="summary-value">${request.vitals?.spo2 || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div class="symptoms-section">
                            <h4>ü©∫ Chief Complaint:</h4>
                            <div class="symptoms-list">${request.chiefComplaint}</div>
                        </div>
                        
                        <div class="symptoms-section">
                            <h4>üìù Symptoms:</h4>
                            <div class="symptoms-list">${request.symptoms}</div>
                        </div>
                        
                        <div class="symptoms-section">
                            <h4>üìã Medical History:</h4>
                            <div class="symptoms-list">${request.medicalHistory}</div>
                        </div>
                        
                        ${request.originalDiagnosis ? `
                        <div class="original-diagnosis-section">
                            <h4>ü§ñ Original AI Diagnosis:</h4>
                            <div class="diagnosis-card">
                                <div class="diagnosis-header">
                                    <span class="diagnosis-name">${request.originalDiagnosis.primary}</span>
                                    <span class="confidence-badge confidence-${request.originalDiagnosis.confidence >= 80 ? 'high' : request.originalDiagnosis.confidence >= 60 ? 'medium' : 'low'}">
                                        ${request.originalDiagnosis.confidence}% confidence
                                    </span>
                                </div>
                                ${request.originalDiagnosis.differential && request.originalDiagnosis.differential.length > 0 ? `
                                <div class="differential-diagnoses">
                                    <strong>Differential Diagnoses:</strong>
                                    <ul>
                                        ${request.originalDiagnosis.differential.map(diff => `<li>${diff.condition} (${diff.probability}%)</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                                ${request.originalDiagnosis.reasoning ? `
                                <div class="diagnosis-reasoning">
                                    <strong>AI Reasoning:</strong>
                                    <p>${request.originalDiagnosis.reasoning}</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${request.attachments && request.attachments.length > 0 ? `
                        <div class="symptoms-section">
                            <h4>üìé Attachments:</h4>
                            <div class="symptoms-list">${request.attachments.join(', ')}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="request-actions">
                        <button class="action-btn accept-btn" onclick="acceptConsultation(${request.id})">
                            ‚úÖ Accept & Respond
                        </button>
                        <button class="action-btn response-btn" onclick="provideSecondOpinion(${request.id})">
                            ü©∫ Provide Second Opinion
                        </button>
                        <button class="action-btn chat-btn" onclick="startQuickChat(${request.id})">
                            üí¨ Quick Chat
                        </button>
                        <button class="action-btn view-btn" onclick="viewFullDetails(${request.id})">
                            üëÅÔ∏è View Details
                        </button>
                        <button class="action-btn decline-btn" onclick="declineConsultation(${request.id})">
                            ‚ùå Decline
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadActiveConsultations() {
            const container = document.getElementById('activeConsultations');
            
            container.innerHTML = activeConsultations.map(consultation => `
                <div class="consultation-card">
                    <div class="consultation-header">
                        <div>
                            <h3>üë§ ${consultation.patientName}</h3>
                            <div class="meta-item">
                                <span>üë®‚Äç‚öïÔ∏è</span>
                                <span>With: ${consultation.requestedBy}</span>
                            </div>
                            <div class="meta-item">
                                <span>‚è∞</span>
                                <span>Started: ${consultation.startTime}</span>
                            </div>
                        </div>
                        <div class="consultation-status ${consultation.status.toLowerCase().replace(' ', '-')}">
                            ${consultation.status}
                        </div>
                    </div>
                    
                    <div class="last-message">
                        üí¨ "${consultation.lastMessage}"
                    </div>
                    
                    <div class="request-actions">
                        <button class="action-btn chat-btn" onclick="openChat(${consultation.id})">
                            üí¨ Continue Chat
                        </button>
                        <button class="action-btn view-btn" onclick="viewConsultationHistory(${consultation.id})">
                            üìã View History
                        </button>
                        <button class="action-btn accept-btn" onclick="completeConsultation(${consultation.id})">
                            ‚úÖ Complete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function generateSchedule() {
            const scheduleGrid = document.querySelector('.schedule-grid');
            const timeSlots = ['9:00', '10:00', '11:00', '12:00', '14:00', '15:00', '16:00', '17:00'];
            
            // Clear existing time slots
            const existingSlots = scheduleGrid.querySelectorAll('.time-slot');
            existingSlots.forEach(slot => slot.remove());
            
            // Generate time slots for each day
            timeSlots.forEach(time => {
                for (let day = 0; day < 7; day++) {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.textContent = time;
                    
                    // Randomly assign availability for demo
                    const rand = Math.random();
                    if (rand < 0.6) {
                        slot.classList.add('available');
                    } else if (rand < 0.8) {
                        slot.classList.add('partially');
                    } else {
                        slot.classList.add('busy');
                    }
                    
                    slot.onclick = () => toggleTimeSlot(slot);
                    scheduleGrid.appendChild(slot);
                }
            });
        }

        function toggleTimeSlot(slot) {
            const classes = ['available', 'partially', 'busy'];
            let currentIndex = classes.findIndex(cls => slot.classList.contains(cls));
            
            // Remove current class
            slot.classList.remove(classes[currentIndex]);
            
            // Add next class (cycle through)
            currentIndex = (currentIndex + 1) % classes.length;
            slot.classList.add(classes[currentIndex]);
        }

        function updateNotificationBadges() {
            document.getElementById('requestsBadge').textContent = consultationRequests.length;
            document.getElementById('activeBadge').textContent = activeConsultations.length;
            
            // Update header stats
            document.getElementById('pendingRequests').textContent = consultationRequests.length;
            document.getElementById('activeConsultations').textContent = activeConsultations.length;
        }

        async function acceptConsultation(requestId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/consultations/${requestId}/accept`, {
                    method: 'POST',
                    body: JSON.stringify({
                        estimated_duration: 30, // Default 30 minutes
                        scheduled_at: new Date().toISOString()
                    })
                });
                
                if (response && response.ok) {
                    // Refresh the lists
                    await loadConsultationRequestsFromAPI();
                    await loadActiveConsultationsFromAPI();
                    await loadConsultationStats();
                    
                    alert('Consultation accepted successfully. You can now start the consultation.');
                    
                    // Simulate opening chat
                    setTimeout(() => {
                        window.open('specialist_chat.html', '_blank');
                    }, 1000);
                } else if (response) {
                    const error = await response.json();
                    alert(`Error accepting consultation: ${error.detail || 'Unknown error'}`);
                } else {
                    alert('Authentication required. Please log in again.');
                }
            } catch (error) {
                console.error('Error accepting consultation:', error);
                alert('Error accepting consultation. Please try again.');
            }
        }

        async function declineConsultation(requestId) {
            if (confirm('Are you sure you want to decline this consultation request?')) {
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/consultations/${requestId}/decline`, {
                        method: 'POST'
                    });
                    
                    if (response && response.ok) {
                        // Refresh the lists
                        await loadConsultationRequestsFromAPI();
                        await loadConsultationStats();
                        
                        alert('Consultation request declined. The requesting healthcare worker will be notified and can seek another specialist.');
                    } else if (response) {
                        const error = await response.json();
                        alert(`Error declining consultation: ${error.detail || 'Unknown error'}`);
                    } else {
                        alert('Authentication required. Please log in again.');
                    }
                } catch (error) {
                    console.error('Error declining consultation:', error);
                    alert('Error declining consultation. Please try again.');
                }
            }
        }

        function startQuickChat(requestId) {
            const request = consultationRequests.find(r => r.id === requestId);
            if (request) {
                alert(`Starting quick chat with ${request.requestedBy} about ${request.patientName}.\n\nThis allows for immediate clarification before accepting the full consultation.`);
                // In real app, would open a quick chat interface
            }
        }

        function viewFullDetails(requestId) {
            const request = consultationRequests.find(r => r.id === requestId);
            if (request) {
                alert(`Full Patient Details:\n\nName: ${request.patientName}\nAge: ${request.age}\nComplaint: ${request.chiefComplaint}\nSymptoms: ${request.symptoms}\nHistory: ${request.medicalHistory}\nVitals: BP ${request.vitals?.bp || 'N/A'}, HR ${request.vitals?.hr || 'N/A'}\nAttachments: ${request.attachments?.join(', ') || 'None'}`);
            }
        }

        function provideSecondOpinion(requestId) {
            const request = consultationRequests.find(r => r.id === requestId);
            if (!request) return;

            // Create modal for structured second opinion
            const modal = document.createElement('div');
            modal.className = 'second-opinion-modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Second Opinion Response</h3>
                        <span class="close-modal" onclick="this.closest('.second-opinion-modal').remove()">&times;</span>
                    </div>
                    
                    <div class="modal-body">
                        <div class="patient-summary">
                            <h4>Patient: ${request.patientName} (${request.age}y, ${request.gender})</h4>
                            <p><strong>Chief Complaint:</strong> ${request.chiefComplaint}</p>
                            <p><strong>Original Diagnosis:</strong> ${request.originalDiagnosis.primary} (${request.originalDiagnosis.confidence}% confidence)</p>
                        </div>

                        <form id="secondOpinionForm">
                            <div class="form-group">
                                <label>Do you agree with the original diagnosis?</label>
                                <select id="diagnosisAgreement" required>
                                    <option value="">Select...</option>
                                    <option value="agree">Agree with diagnosis</option>
                                    <option value="partially">Partially agree</option>
                                    <option value="disagree">Disagree with diagnosis</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Your Primary Diagnosis:</label>
                                <input type="text" id="primaryDiagnosis" placeholder="Enter your primary diagnosis" required>
                            </div>

                            <div class="form-group">
                                <label>Confidence Level (%):</label>
                                <input type="number" id="confidenceLevel" min="1" max="100" placeholder="85" required>
                            </div>

                            <div class="form-group">
                                <label>Alternative Diagnoses (if any):</label>
                                <textarea id="alternativeDiagnoses" placeholder="List alternative diagnoses to consider..." rows="3"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Clinical Reasoning:</label>
                                <textarea id="clinicalReasoning" placeholder="Explain your diagnostic reasoning..." rows="4" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Recommended Actions:</label>
                                <textarea id="recommendations" placeholder="Treatment recommendations, additional tests, referrals..." rows="4" required></textarea>
                            </div>

                            <div class="form-group">
                                <label>Urgency Level:</label>
                                <select id="urgencyLevel" required>
                                    <option value="">Select urgency...</option>
                                    <option value="immediate">Immediate (Emergency)</option>
                                    <option value="urgent">Urgent (Within 24 hours)</option>
                                    <option value="routine">Routine (Within 1 week)</option>
                                    <option value="follow-up">Follow-up as scheduled</option>
                                </select>
                            </div>

                            <div class="form-actions">
                                <button type="button" onclick="this.closest('.second-opinion-modal').remove()" class="btn-cancel">Cancel</button>
                                <button type="submit" class="btn-submit">Send Second Opinion</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('secondOpinionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    requestId: requestId,
                    agreement: document.getElementById('diagnosisAgreement').value,
                    primaryDiagnosis: document.getElementById('primaryDiagnosis').value,
                    confidence: document.getElementById('confidenceLevel').value,
                    alternativeDiagnoses: document.getElementById('alternativeDiagnoses').value,
                    reasoning: document.getElementById('clinicalReasoning').value,
                    recommendations: document.getElementById('recommendations').value,
                    urgency: document.getElementById('urgencyLevel').value,
                    timestamp: new Date().toISOString(),
                    specialistName: "Dr. Sarah Mwangi" // In real app, get from user session
                };

                try {
                    // In real app, send to backend API
                    console.log('Second Opinion Response:', formData);
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    alert('Second opinion sent successfully! The healthcare worker will be notified.');
                    modal.remove();
                    
                    // Remove the request from the list (simulate completion)
                    const requestIndex = consultationRequests.findIndex(r => r.id === requestId);
                    if (requestIndex > -1) {
                        consultationRequests.splice(requestIndex, 1);
                        loadConsultationRequests();
                        updateNotificationBadges();
                    }
                    
                } catch (error) {
                    console.error('Error sending second opinion:', error);
                    alert('Error sending second opinion. Please try again.');
                }
            });
        }

        function openChat(consultationId) {
            window.open('specialist_chat.html', '_blank');
        }

        function viewConsultationHistory(consultationId) {
            alert('Opening consultation history...\n\nThis would show the complete conversation log, shared files, and consultation notes.');
        }

        function completeConsultation(consultationId) {
            if (confirm('Mark this consultation as complete?')) {
                const index = activeConsultations.findIndex(c => c.id === consultationId);
                if (index > -1) {
                    activeConsultations.splice(index, 1);
                    updateNotificationBadges();
                    loadActiveConsultations();
                    alert('Consultation completed. Summary and recommendations have been saved to the patient record.');
                }
            }
        }

        function editSchedule() {
            alert('Opening schedule editor...\n\nThis would allow you to set your availability hours, recurring schedules, and time off periods.');
        }

        function blockTime() {
            alert('Block time periods...\n\nSelect time slots to mark as unavailable for consultations.');
        }

        function setRecurring() {
            alert('Set recurring schedule...\n\nDefine your weekly availability pattern that repeats automatically.');
        }

        function emergencyMode() {
            if (confirm('Enable emergency-only mode?\n\nYou will only receive urgent/emergency consultation requests.')) {
                alert('Emergency mode enabled. You will only receive high-priority consultation requests.');
            }
        }

        function viewDetailedAnalytics() {
            alert('Opening detailed analytics...\n\nThis would show comprehensive reports on your consultation patterns, patient outcomes, and performance metrics.');
        }

        function exportData() {
            alert('Exporting consultation data...\n\nThis would generate a downloadable report of your consultation history and statistics.');
        }

        function feedbackReview() {
            alert('Opening patient feedback...\n\nThis would show ratings and comments from healthcare workers and patients you\'ve helped.');
        }

        // API Integration Functions
        const API_BASE_URL = '/api/v1';
        
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    console.log('Authentication failed, redirecting to login');
                    window.location.href = 'login.html';
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        async function loadConsultationRequestsFromAPI() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/consultations/requests`);
                if (response && response.ok) {
                    const data = await response.json();
                    consultationRequests.length = 0;
                    consultationRequests.push(...(data.consultations || []));
                    updateNotificationBadges();
                    loadConsultationRequests();
                } else if (response) {
                    console.error('Failed to load consultation requests:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading consultation requests:', error);
            }
        }

        async function loadActiveConsultationsFromAPI() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/consultations/active`);
                if (response && response.ok) {
                    const data = await response.json();
                    activeConsultations.length = 0;
                    activeConsultations.push(...(data.consultations || []));
                    loadActiveConsultations();
                } else if (response) {
                    console.error('Failed to load active consultations:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading active consultations:', error);
            }
        }

        async function loadConsultationStats() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/consultations/stats`);
                if (response && response.ok) {
                    const stats = await response.json();
                    updateDashboardStats(stats);
                } else if (response) {
                    console.error('Failed to load consultation stats:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error loading consultation stats:', error);
            }
        }

        function updateDashboardStats(stats) {
            document.getElementById('pendingRequests').textContent = stats.pending_consultations || 0;
            document.getElementById('activeConsultations').textContent = stats.active_consultations || 0;
            document.getElementById('todayConsultations').textContent = stats.today_consultations || 0;
        }

        // Real-time updates every 30 seconds
        setInterval(() => {
            loadConsultationRequestsFromAPI();
            loadActiveConsultationsFromAPI();
            loadConsultationStats();
        }, 30000);
    </script>
</body>
</html>